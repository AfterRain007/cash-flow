<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ’° Rain's Bag ðŸ’°</title>
    <link rel="icon" href="./public/images/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!--     <link rel="stylesheet" href="./public/style.css"> -->
  </head>
  <body>
    <main class="container pt-5">
      <h3 class="row mb-3 d-flex justify-content-center align-items-center">
        Money Management
      </h3>
      <div class="row mb-3">
        <div class="col-12 col-lg-3" style="height: 40vh;">
          <canvas id="classificationChart" style="display: block"></canvas>
        </div>
        <div class="col-12 col-lg-5" style="height: 40vh;">
          <canvas id="creditLineChart" style="display: block"></canvas>
        </div>
      </div>
      <div class="row">
        <div class="col-12" style="height: 40vh;">
          <canvas id="stackedBarChart" style="display: block;"></canvas>
        </div>
      </div>
    </main>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous" defer></script>
      
    <script>
      $(document).ready(function() {
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-YxrBUuqBO3hvqqG-qb7W2lKp4g2xLOn5b1qljCGuMxSJBss21spSzxSkiDPQ1aqy-Q_2Ot5U9RXV/pub?gid=985685597&single=true&output=csv';
    
        $.ajax({
          url: sheetUrl,
          dataType: 'text',
          success: function(data) {
            const rows = data.split("\n").map(row => row.split(","));
            const headers = rows.shift(); // Extract headers (not used here)
    
            const classifications = {}; // For pie chart data
            const classificationOverTime = {}; // For line chart data
            const monthlyData = {}; // For stacked bar chart data
    
            rows.forEach(row => {
              const date = row[0]?.trim(); // Date column
              const classification = row[1]?.trim(); // Classification column
              const sumCredit = parseFloat(row[2]) || 0; // SUM of Credit
              const sumDebit = parseFloat(row[3]) || 0; // SUM of Debit
    
              if (classification && classification !== "Grand Total") {
                // Accumulate Credit for Pie Chart
                if (sumCredit > 0) {
                  classifications[classification] = (classifications[classification] || 0) + sumCredit;
                }
    
                // Accumulate Credit Over Time for Line Chart
                if (date) {
                  classificationOverTime[classification] = classificationOverTime[classification] || {};
                  classificationOverTime[classification][date] = (classificationOverTime[classification][date] || 0) + sumCredit;
                }
              }
    
              if (date && date !== "Grand Total") {
                // Accumulate Monthly Debit and Credit for Stacked Bar Chart
                monthlyData[date] = monthlyData[date] || { credit: 0, debit: 0 };
                monthlyData[date].credit += sumCredit;
                monthlyData[date].debit += sumDebit;
              }
            });
    
            // Prepare Pie Chart Data
            const pieLabels = Object.keys(classifications); // Classification labels
            const pieDataValues = Object.values(classifications); // Corresponding sums
    
            // Utility to generate random colors
            function getRandomColor() {
              return `#${Math.floor(Math.random() * 16777215).toString(16)}`;
            }
    
            // Prepare Line Chart Data
            const lineLabels = Array.from(new Set(rows.map(row => row[0]?.trim()).filter(date => date && date !== "Grand Total"))); // Unique Dates
    
            const lineDatasets = Object.keys(classificationOverTime)
              .filter(classification => {
                return Object.values(classificationOverTime[classification]).some(credit => credit > 0);
              })
              .map(classification => ({
                label: classification,
                data: lineLabels.map(date => classificationOverTime[classification][date] || 0),
                borderColor: getRandomColor(),
                fill: false
              }));
    
            // Prepare Stacked Bar Chart Data
            const barLabels = Object.keys(monthlyData); // Monthly dates
            const debitData = barLabels.map(date => monthlyData[date].debit);
            const creditData = barLabels.map(date => monthlyData[date].credit);
    
            // Pie Chart: Classifications
            const ctxPie = document.getElementById("classificationChart").getContext("2d");
            new Chart(ctxPie, {
              type: "pie",
              data: {
                labels: pieLabels,
                datasets: [{
                  label: "Classifications",
                  data: pieDataValues,
                  backgroundColor: [
                    "#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF", "#FF9F40"
                  ],
                  hoverOffset: 4
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio : false,
                plugins: {
                  legend: { position: "top" },
                  tooltip: { enabled: true }
                }
              }
            });
    
            // Line Chart: Credit by Classification Over Time
            const ctxLine = document.getElementById("creditLineChart").getContext("2d");
            new Chart(ctxLine, {
              type: "line",
              data: {
                labels: lineLabels,
                datasets: lineDatasets
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: "top" },
                  tooltip: {
                    enabled: true,
                    intersect: false,
                    mode: 'index'
                  }
                },
                interaction: {
                  mode: 'index',
                  intersect: false
                },
                scales: {
                  x: { title: { display: true, text: "Months" } },
                  y: { title: { display: true, text: "Credit Amount" } }
                }
              }
            });
    
            // Stacked Bar Chart: Debit vs Credit
            const ctxBar = document.getElementById("stackedBarChart").getContext("2d");
            new Chart(ctxBar, {
              type: "bar",
              data: {
                labels: barLabels,
                datasets: [
                  {
                    label: "Debit",
                    data: debitData,
                    backgroundColor: "#FF6384"
                  },
                  {
                    label: "Credit",
                    data: creditData,
                    backgroundColor: "#36A2EB"
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: "top" },
                  tooltip: {
                    enabled: true,
                    intersect: false,
                    mode: 'index'
                  }
                },
                interaction: {
                  mode: 'index',
                  intersect: false
                },
                scales: {
                  x: { 
                    stacked: true, 
                    title: { display: true, text: "Months" } 
                  },
                  y: { 
                    stacked: true, 
                    title: { display: true, text: "Amount" } 
                  }
                }
              }
            });
          } // End of success function
        }); // End of $.ajax
      }); // End of $(document).ready
    </script>
    
  </body>
</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° Rain's Bag ğŸ’°</title>
    <link rel="icon" href="./public/images/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!--     <link rel="stylesheet" href="./public/style.css"> -->
  </head>
  <body>
    <main class="container pt-5">
      <h3 class="row mb-3 d-flex justify-content-center align-items-center">
        Money Management
      </h3>
      <div>
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate">
        
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate">
        
        <button id="applyFilter">Apply Filter</button>
      </div>      
      <div class="row mb-3">
        <div class="col-12 col-lg-3" style="height: 40vh;">
          <canvas id="classificationChart" style="display: block"></canvas>
        </div>
        <div class="col-12 col-lg-5" style="height: 40vh;">
          <canvas id="creditLineChart" style="display: block"></canvas>
        </div>
      </div>
      <div class="row">
        <div class="col-12" style="height: 40vh;">
          <canvas id="stackedBarChart" style="display: block;"></canvas>
        </div>
      </div>
    </main>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous" defer></script>
      
    <script>
      $(document).ready(function() {
  const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-YxrBUuqBO3hvqqG-qb7W2lKp4g2xLOn5b1qljCGuMxSJBss21spSzxSkiDPQ1aqy-Q_2Ot5U9RXV/pub?gid=985685597&single=true&output=csv';
  
  let originalData = []; // To store unfiltered data
  let pieChart, lineChart, barChart; // Chart instances
  
  $.ajax({
    url: sheetUrl,
    dataType: 'text',
    success: function(data) {
      originalData = data.split("\n").map(row => row.split(","));
      const headers = originalData.shift(); // Remove and store headers

      function filterAndRenderCharts(startDate, endDate) {
        const filteredRows = originalData.filter(row => {
          const date = row[0]?.trim();
          if (date) {
            const rowDate = new Date(date);
            return (!startDate || rowDate >= startDate) && (!endDate || rowDate <= endDate);
          }
          return false;
        });
        
        // Process filtered rows
        const classifications = {};
        const classificationOverTime = {};
        const monthlyData = {};
        
        filteredRows.forEach(row => {
          const date = row[0]?.trim();
          const classification = row[1]?.trim();
          const sumCredit = parseFloat(row[2]) || 0;
          const sumDebit = parseFloat(row[3]) || 0;

          if (classification && classification !== "Grand Total") {
            if (sumCredit > 0) {
              classifications[classification] = (classifications[classification] || 0) + sumCredit;
            }
            if (date) {
              classificationOverTime[classification] = classificationOverTime[classification] || {};
              classificationOverTime[classification][date] = (classificationOverTime[classification][date] || 0) + sumCredit;
            }
          }
          
          if (date && date !== "Grand Total") {
            monthlyData[date] = monthlyData[date] || { credit: 0, debit: 0 };
            monthlyData[date].credit += sumCredit;
            monthlyData[date].debit += sumDebit;
          }
        });

        // Prepare data for charts
        const pieLabels = Object.keys(classifications);
        const pieDataValues = Object.values(classifications);

        const lineLabels = Array.from(new Set(filteredRows.map(row => row[0]?.trim())));
        const lineDatasets = Object.keys(classificationOverTime).map(classification => ({
          label: classification,
          data: lineLabels.map(date => classificationOverTime[classification][date] || 0),
          borderColor: getRandomColor(),
          fill: false
        }));

        const barLabels = Object.keys(monthlyData);
        const debitData = barLabels.map(date => monthlyData[date].debit);
        const creditData = barLabels.map(date => monthlyData[date].credit);

        // Update or Create Charts
        if (pieChart) pieChart.destroy();
        if (lineChart) lineChart.destroy();
        if (barChart) barChart.destroy();

        const ctxPie = document.getElementById("classificationChart").getContext("2d");
        pieChart = new Chart(ctxPie, {
          type: "pie",
          data: {
            labels: pieLabels,
            datasets: [{
              label: "Classifications",
              data: pieDataValues,
              backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF", "#FF9F40"],
              hoverOffset: 4
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });

        const ctxLine = document.getElementById("creditLineChart").getContext("2d");
        lineChart = new Chart(ctxLine, {
          type: "line",
          data: {
            labels: lineLabels,
            datasets: lineDatasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: "top" } }
          }
        });

        const ctxBar = document.getElementById("stackedBarChart").getContext("2d");
        barChart = new Chart(ctxBar, {
          type: "bar",
          data: {
            labels: barLabels,
            datasets: [
              { label: "Debit", data: debitData, backgroundColor: "#FF6384" },
              { label: "Credit", data: creditData, backgroundColor: "#36A2EB" }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { x: { stacked: true }, y: { stacked: true } }
          }
        });
      }

      // Initial render with all data
      filterAndRenderCharts();

      // Apply filter on button click
      $('#applyFilter').click(() => {
        const startDate = new Date($('#startDate').val());
        const endDate = new Date($('#endDate').val());
        filterAndRenderCharts(startDate, endDate);
      });
    }
  });
});

    </script>
  </body>
</html>